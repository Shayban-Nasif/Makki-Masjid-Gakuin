<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | MMG</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; }
        .admin-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header { background: var(--primary); color: white; padding: 15px 25px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        .tab-menu { display: flex; gap: 5px; margin-top: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #e0e0e0; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f1f5f4; color: var(--primary); border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .search-box { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>Admin Dashboard | MMG</h1>
            <button onclick="logout()" class="btn-primary" style="background:#c62828;">Logout</button>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="openTab(event, 'students-tab')">Students</button>
            <button class="tab-btn" onclick="openTab(event, 'academic-tab')">Academic Table</button>
            <button class="tab-btn" onclick="openTab(event, 'notices-tab')">Notices</button>
        </div>

        <div id="students-tab" class="tab-content active">
            <div class="section">
                <h3>Enroll Student</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <input type="text" id="sName" placeholder="Student Name" class="search-box" style="margin:0">
                    <input type="email" id="sParentEmail" placeholder="Parent Email" class="search-box" style="margin:0">
                    <select id="sDivision" class="search-box" style="margin:0">
                        <option value="Maktab">Maktab</option>
                        <option value="Nazera">Nazera</option>
                        <option value="Hifz">Hifz</option>
                    </select>
                    <button onclick="addStudent()" class="btn-primary">Enroll</button>
                </div>
            </div>
            <div class="section" id="studentListArea"></div>
        </div>

        <div id="academic-tab" class="tab-content">
            <div class="section">
                <h3>Monthly Student Records</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <select id="acadStudentSelect" class="search-box" onchange="loadMonthlyTable()" style="margin:0"></select>
                    <select id="acadMonthSelect" class="search-box" onchange="loadMonthlyTable()" style="margin:0">
                        <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                        <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                        <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                        <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                    </select>
                </div>
                <table>
                    <thead><tr><th>Date</th><th>Progress Details</th></tr></thead>
                    <tbody id="monthlyAcademicBody"></tbody>
                </table>
            </div>
        </div>

        <div id="notices-tab" class="tab-content">
            <div class="section">
                <h3>Notice Board</h3>
                <textarea id="noticeMsg" class="search-box" style="height:100px" placeholder="Post announcement..."></textarea>
                <button onclick="sendNotice()" class="btn-primary">Post Notice</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, query, where, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.openTab = (evt, tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
            if(tabId === 'academic-tab') populateStudentDropdown();
        };

        window.addStudent = async () => {
            const name = document.getElementById('sName').value;
            const email = document.getElementById('sParentEmail').value.toLowerCase().trim();
            if(!name || !email) return alert("Required fields missing");
            await addDoc(collection(db, "students"), {
                name, parentEmail: email,
                division: document.getElementById('sDivision').value,
                levels: {c1:0, c2:0, c3:0},
                logs: []
            });
            await setDoc(doc(db, "users", email), { email, role: 'parent', name: name + " Parent" }, { merge: true });
            alert("Enrolled!");
            location.reload();
        };

        async function populateStudentDropdown() {
            const snap = await getDocs(collection(db, "students"));
            const select = document.getElementById('acadStudentSelect');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            snap.forEach(d => select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`);
        }

        window.loadMonthlyTable = async () => {
            const sid = document.getElementById('acadStudentSelect').value;
            const month = parseInt(document.getElementById('acadMonthSelect').value);
            if(!sid) return;
            const snap = await getDocs(collection(db, "students"));
            const student = snap.docs.find(d => d.id === sid).data();
            const filtered = (student.logs || []).filter(l => {
                const dateParts = l.date.split('/'); // Assuming DD/MM/YYYY or YYYY/MM/DD
                return l.type === "academic";
            });
            const body = document.getElementById('monthlyAcademicBody');
            body.innerHTML = filtered.length ? filtered.map(l => `<tr><td>${l.date}</td><td>${l.text}</td></tr>`).join('') : "<tr><td>No records found</td></tr>";
        };

        window.sendNotice = async () => {
            const msg = document.getElementById('noticeMsg').value;
            if(!msg) return;
            await addDoc(collection(db, "notices"), { message: msg, timestamp: serverTimestamp(), date: new Date().toLocaleDateString() });
            alert("Notice Posted!");
        };

        window.logout = () => { localStorage.clear(); window.location.href='index.html'; };
    </script>
</body>
</html>
