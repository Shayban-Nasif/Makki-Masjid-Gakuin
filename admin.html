<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Makki Masjid Gakuin</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; --red: #e57373; --green: #81c784; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; }
        .header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid var(--gold); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Tabs */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #e0e0e0; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; width: 90%; max-width: 850px; border-radius: 12px; }
        .modal-header { background: var(--primary); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        /* Attendance Dot Grid */
        .att-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .att-dot { width: 25px; height: 25px; border-radius: 4px; background: #eee; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .present { background: var(--green); color: white; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Admin Control Panel</h1>
        <div>
            <span id="admin-name">Admin</span>
            <button onclick="logout()" style="margin-left:15px; background:#c62828; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card"><h3 id="count-total">0</h3><small>Total Students</small></div>
            <div class="stat-card"><h3 id="count-maktab">0</h3><small>Maktab</small></div>
            <div class="stat-card"><h3 id="count-nazera">0</h3><small>Nazera</small></div>
            <div class="stat-card"><h3 id="count-hifz">0</h3><small>Hifz</small></div>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('students')">Students</button>
            <button class="tab-btn" onclick="switchTab('enroll')">Enrollment</button>
            <button class="tab-btn" onclick="switchTab('teachers')">Teachers</button>
            <button class="tab-btn" onclick="switchTab('notices')">Notice Board</button>
        </div>

        <div id="sec-students" class="section active">
            <input type="text" id="search" placeholder="ðŸ” Search student..." onkeyup="filterTable()" style="width:100%; padding:10px; margin-bottom:20px; border-radius:5px; border:1px solid #ddd;">
            <table>
                <thead>
                    <tr><th>Name (Age)</th><th>Division</th><th>Monthly Fee</th><th>Services</th><th>Actions</th></tr>
                </thead>
                <tbody id="student-table"></tbody>
            </table>
        </div>

        <div id="sec-enroll" class="section">
            <h3>Enroll New Student</h3>
            <div class="input-grid">
                <div><label>Name</label><input type="text" id="en-name"></div>
                <div><label>Parent Email</label><input type="email" id="en-email"></div>
                <div><label>DOB</label><input type="date" id="en-dob"></div>
                <div>
                    <label>Division</label>
                    <select id="en-div">
                        <option value="Maktab">Maktab</option>
                        <option value="Nazera">Nazera</option>
                        <option value="Hifz">Hifz</option>
                    </select>
                </div>
            </div>
            <button class="tab-btn active" onclick="enrollNew()">Submit Enrollment</button>
        </div>

        <div id="sec-teachers" class="section">
            <h3>Teacher Management</h3>
            <div class="input-grid">
                <input type="text" id="t-name" placeholder="Teacher Name">
                <input type="email" id="t-email" placeholder="Teacher Email">
                <button class="tab-btn active" onclick="addTeacher()">Add Teacher</button>
            </div>
            <table id="teacher-table"><thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead><tbody id="teacher-body"></tbody></table>
        </div>

        <div id="sec-notices" class="section">
            <h3>ðŸ“¢ Broadcast Notice</h3>
            <textarea id="notice-msg" style="width:100%; height:80px; margin-bottom:10px;"></textarea>
            <button class="tab-btn active" onclick="postNotice()">Send to Parents</button>
            <table style="margin-top:20px;"><thead><tr><th>Date</th><th>Message</th></tr></thead><tbody id="notice-body"></tbody></table>
        </div>
    </div>

    <div id="hubModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="hub-title">Student Profile</h3><span onclick="closeModal()" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <input type="hidden" id="hub-id">
                <div class="input-grid">
                    <div><label>Division</label>
                        <select id="hub-div" onchange="refreshGoalLabels()">
                            <option value="Maktab">Maktab</option>
                            <option value="Nazera">Nazera</option>
                            <option value="Hifz">Hifz</option>
                        </select>
                    </div>
                    <div><label>Target ETA</label><input type="date" id="hub-eta"></div>
                    <div><label>Monthly Fee (Â¥)</label><input type="number" id="hub-fee"></div>
                </div>
                <div class="input-grid">
                    <div><label id="lbl-g1">Goal 1</label><input type="number" id="hub-g1"></div>
                    <div><label id="lbl-g2">Goal 2</label><input type="number" id="hub-g2"></div>
                    <div><label id="lbl-g3">Goal 3</label><input type="number" id="hub-g3"></div>
                </div>
                <div class="input-grid">
                    <div><label>Transport Fee</label><input type="number" id="hub-trans"></div>
                    <div><label>Daylong Fee</label><input type="number" id="hub-day"></div>
                </div>
                <label>Attendance (This Month)</label>
                <div id="hub-attendance" class="att-grid"></div>
                <label style="margin-top:15px;">Teacher Feedback</label>
                <textarea id="hub-feedback" style="width:100%; height:60px;"></textarea>
                <div style="margin-top:20px; display:flex; justify-content:space-between;">
                    <button onclick="saveHub()" class="tab-btn active">Save All Changes</button>
                    <button onclick="deleteStudent()" style="background:red; color:white; border:none; padding:10px; border-radius:5px;">Delete Student</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, query, where, deleteDoc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.loadData = async () => {
            const snap = await getDocs(collection(db, "students"));
            const tbody = document.getElementById('student-table');
            tbody.innerHTML = "";
            let stats = {Maktab:0, Nazera:0, Hifz:0, Total:0};

            snap.forEach(d => {
                const s = {id: d.id, ...d.data()};
                stats.Total++; stats[s.division]++;
                const age = s.dob ? Math.floor((new Date() - new Date(s.dob))/31557600000) : "N/A";
                const totalFee = (s.monthlyFee||0) + (s.transportFee||0) + (s.daylongFee||0);
                
                tbody.innerHTML += `<tr>
                    <td><strong>${s.name}</strong> (${age}y)</td>
                    <td>${s.division}</td>
                    <td>Â¥${totalFee}</td>
                    <td>${s.transportFee > 0 ? 'ðŸšŒ':''} ${s.daylongFee > 0 ? 'ðŸ“–':''}</td>
                    <td><button onclick="openHub('${s.id}')">Edit Profile</button></td>
                </tr>`;
            });
            document.getElementById('count-total').innerText = stats.Total;
            document.getElementById('count-maktab').innerText = stats.Maktab;
            document.getElementById('count-nazera').innerText = stats.Nazera;
            document.getElementById('count-hifz').innerText = stats.Hifz;
            loadTeachers(); loadNotices();
        };

        window.openHub = async (id) => {
            const snap = await getDocs(collection(db, "students"));
            const s = snap.docs.find(d => d.id === id).data();
            document.getElementById('hub-id').value = id;
            document.getElementById('hub-div').value = s.division;
            document.getElementById('hub-fee').value = s.monthlyFee || 0;
            document.getElementById('hub-trans').value = s.transportFee || 0;
            document.getElementById('hub-day').value = s.daylongFee || 0;
            document.getElementById('hub-g1').value = s.goals[0] || 0;
            document.getElementById('hub-g2').value = s.goals[1] || 0;
            document.getElementById('hub-g3').value = s.goals[2] || 0;
            document.getElementById('hub-feedback').value = s.feedback || "";
            document.getElementById('hub-eta').value = s.eta || "";
            
            // Attendance Grid Restored
            const attGrid = document.getElementById('hub-attendance');
            attGrid.innerHTML = "";
            const attendance = s.attendance || [];
            for(let i=1; i<=31; i++) {
                const isPresent = attendance.includes(i);
                attGrid.innerHTML += `<div class="att-dot ${isPresent?'present':''}" onclick="toggleAtt(${i})">${i}</div>`;
            }
            
            refreshGoalLabels();
            document.getElementById('hubModal').style.display = 'block';
        };

        window.toggleAtt = (day) => { event.currentTarget.classList.toggle('present'); };

        window.saveHub = async () => {
            const id = document.getElementById('hub-id').value;
            const att = [];
            document.querySelectorAll('.att-dot.present').forEach(d => att.push(parseInt(d.innerText)));
            
            await updateDoc(doc(db, "students", id), {
                division: document.getElementById('hub-div').value,
                monthlyFee: parseInt(document.getElementById('hub-fee').value),
                transportFee: parseInt(document.getElementById('hub-trans').value),
                daylongFee: parseInt(document.getElementById('hub-day').value),
                goals: [document.getElementById('hub-g1').value, document.getElementById('hub-g2').value, document.getElementById('hub-g3').value],
                feedback: document.getElementById('hub-feedback').value,
                eta: document.getElementById('hub-eta').value,
                attendance: att
            });
            closeModal(); loadData();
        };

        window.refreshGoalLabels = () => {
            const d = document.getElementById('hub-div').value;
            const l1 = document.getElementById('lbl-g1'), l2 = document.getElementById('lbl-g2'), l3 = document.getElementById('lbl-g3');
            if(d==='Hifz'){ l1.innerText="Para"; l2.innerText="Sabaqi"; l3.innerText="Manzil"; }
            else if(d==='Nazera'){ l1.innerText="Para No"; l2.innerText="Line"; l3.innerText="Tajweed"; }
            else { l1.innerText="Qaida Page"; l2.innerText="Dua No"; l3.innerText="Islamic"; }
        };

        window.enrollNew = async () => {
            await addDoc(collection(db, "students"), {
                name: document.getElementById('en-name').value,
                parentEmail: document.getElementById('en-email').value.toLowerCase(),
                dob: document.getElementById('en-dob').value,
                division: document.getElementById('en-div').value,
                monthlyFee:0, transportFee:0, daylongFee:0, goals:[0,0,0], attendance:[]
            });
            loadData(); switchTab('students');
        };

        async function loadTeachers() {
            const snap = await getDocs(query(collection(db, "users"), where("role", "==", "teacher")));
            const tb = document.getElementById('teacher-body'); tb.innerHTML = "";
            snap.forEach(d => { tb.innerHTML += `<tr><td>${d.data().name}</td><td>${d.data().email}</td><td><button onclick="delT('${d.id}')">Del</button></td></tr>`; });
        }

        async function loadNotices() {
            const snap = await getDocs(query(collection(db, "notices"), orderBy("timestamp", "desc")));
            const tb = document.getElementById('notice-body'); tb.innerHTML = "";
            snap.forEach(d => { tb.innerHTML += `<tr><td>${d.data().date}</td><td>${d.data().message}</td></tr>`; });
        }

        window.postNotice = async () => {
            const msg = document.getElementById('notice-msg').value;
            await addDoc(collection(db, "notices"), { message: msg, date: new Date().toLocaleDateString(), timestamp: new Date() });
            document.getElementById('notice-msg').value = ""; loadNotices();
        };

        window.closeModal = () => document.getElementById('hubModal').style.display = 'none';
        window.logout = () => { localStorage.clear(); window.location.href="index.html"; };
        loadData();
    </script>
</body>
</html>
