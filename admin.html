<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Makki Masjid Gakuin</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; }
        .admin-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .header { background: var(--primary); color: white; padding: 15px 25px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        
        /* Tabs */
        .tab-menu { display: flex; gap: 5px; margin-top: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #e0e0e0; border-radius: 8px 8px 0 0; font-weight: bold; color: #555; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        /* Tables & UI */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th { text-align: left; padding: 12px; background: #f1f5f4; color: var(--primary); font-size: 0.85rem; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .search-box { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        
        /* Academic Table Specifics */
        .academic-controls { display: flex; gap: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        .academic-controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex: 1; }
        
        .status-paid { color: #2e7d32; font-weight: bold; }
        .status-due { color: #c62828; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 5% auto; width: 80%; max-width: 800px; border-radius: 12px; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="admin-container">
        <div class="header">
            <h1>Admin Dashboard | MMG</h1>
            <button onclick="logout()" style="background:#c62828; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="openTab(event, 'students-tab')">Students</button>
            <button class="tab-btn" onclick="openTab(event, 'academic-tab')">Academic Records</button>
            <button class="tab-btn" onclick="openTab(event, 'teachers-tab')">Teachers</button>
            <button class="tab-btn" onclick="openTab(event, 'notices-tab')">Notices</button>
        </div>

        <div id="students-tab" class="tab-content active">
            <div class="section">
                <h3>Quick Enroll</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <input type="text" id="sName" placeholder="Student Name">
                    <input type="email" id="sParentEmail" placeholder="Parent Email">
                    <select id="sGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <select id="sDivision"><option value="Maktab">Maktab</option><option value="Nazera">Nazera</option><option value="Hifz">Hifz</option></select>
                    <input type="number" id="sFee" placeholder="Fee (¬•)">
                    <button onclick="addStudent()" class="btn-primary">Enroll</button>
                </div>
            </div>

            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Directory</h3>
                    <label><input type="checkbox" id="filterTransport" onchange="loadStudents()"> üöå Transport Only</label>
                </div>
                <input type="text" id="studentSearch" class="search-box" placeholder="Search name or parent email..." onkeyup="loadStudents()">
                <div id="divisionContainer"></div>
            </div>
        </div>

        <div id="academic-tab" class="tab-content">
            <div class="section">
                <h3>Monthly Student Progress</h3>
                <div class="academic-controls">
                    <select id="acadStudentSelect" onchange="loadMonthlyAcademicTable()">
                        <option value="">-- Select Student --</option>
                    </select>
                    <select id="acadMonthSelect" onchange="loadMonthlyAcademicTable()">
                        <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                        <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                        <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                        <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                    </select>
                </div>
                <table id="monthlyAcademicTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Progress Details</th>
                            <th>Teacher Note</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyAcademicBody">
                        <tr><td colspan="3" style="text-align:center; padding:40px; color:#999;">Select a student to view records</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="teachers-tab" class="tab-content">
            <div class="section">
                <h3>Teacher Management</h3>
                <div id="teacherList"></div>
            </div>
        </div>

        <div id="notices-tab" class="tab-content">
            <div class="section">
                <h3>Notice Board</h3>
                <textarea id="noticeMsg" class="search-box" style="height:80px" placeholder="Post a message to all parents..."></textarea>
                <button onclick="sendNotice()" class="btn-primary">Post Notice</button>
                <div id="noticeHistory"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, query, where, deleteDoc, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- AUTH & TABS ---
        window.openTab = (evt, tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
            if(tabId === 'academic-tab') populateStudentDropdown();
        };

        // --- STUDENT MGMT ---
        window.addStudent = async () => {
            const name = document.getElementById('sName').value;
            const email = document.getElementById('sParentEmail').value.toLowerCase().trim();
            if(!name || !email) return alert("Fill Name and Parent Email");

            const newStudent = {
                name, parentEmail: email,
                gender: document.getElementById('sGender').value,
                division: document.getElementById('sDivision').value,
                monthlyFee: parseInt(document.getElementById('sFee').value) || 0,
                transportFee: 0,
                levels: { c1:0, c2:0, c3:0 },
                logs: [{ date: new Date().toLocaleDateString(), text: "Enrolled", type: "system" }]
            };

            await addDoc(collection(db, "students"), newStudent);
            await setDoc(doc(db, "users", email), { email, role: 'parent', name: name + " Parent" }, { merge: true });
            alert("Student Added");
            loadStudents();
        };

        window.loadStudents = async () => {
            const snap = await getDocs(collection(db, "students"));
            const container = document.getElementById('divisionContainer');
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const transOnly = document.getElementById('filterTransport').checked;
            
            container.innerHTML = "";
            let html = "<table><thead><tr><th>Name</th><th>Gender</th><th>Parent</th><th>Transport</th><th>Action</th></tr></thead><tbody>";
            
            snap.forEach(d => {
                const s = d.data();
                const matchesSearch = s.name.toLowerCase().includes(search) || s.parentEmail.toLowerCase().includes(search);
                const matchesTrans = transOnly ? (s.transportFee > 0) : true;

                if(matchesSearch && matchesTrans) {
                    html += `<tr>
                        <td><b>${s.name}</b></td>
                        <td>${s.gender}</td>
                        <td>${s.parentEmail}</td>
                        <td>${s.transportFee > 0 ? 'üöå Yes' : 'No'}</td>
                        <td><button onclick="deleteStudent('${d.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                }
            });
            html += "</tbody></table>";
            container.innerHTML = html;
        };

        // --- ACADEMIC RECORDS (STUDENT WISE) ---
        async function populateStudentDropdown() {
            const snap = await getDocs(collection(db, "students"));
            const select = document.getElementById('acadStudentSelect');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            snap.forEach(d => {
                select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
            });
            // Set current month as default
            document.getElementById('acadMonthSelect').value = new Date().getMonth() + 1;
        }

        window.loadMonthlyAcademicTable = async () => {
            const sid = document.getElementById('acadStudentSelect').value;
            const month = parseInt(document.getElementById('acadMonthSelect').value);
            const tbody = document.getElementById('monthlyAcademicBody');
            
            if(!sid) return;
            tbody.innerHTML = '<tr><td colspan="3">Searching...</td></tr>';

            const sDoc = await getDocs(collection(db, "students"));
            const student = sDoc.docs.find(d => d.id === sid).data();
            const logs = student.logs || [];

            // Filter logs by month and by academic type
            const filtered = logs.filter(l => {
                const logDate = new Date(l.date);
                // We look for academic markers like '|' or explicit type
                return (logDate.getMonth() + 1 === month) && (l.type === "academic" || l.text.includes('|'));
            });

            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:orange;">No academic logs found for this month.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(l => `
                <tr>
                    <td>${l.date}</td>
                    <td>${l.text.split('|')[0] || l.text}</td>
                    <td><small>${l.text.split('|')[1] || '-'}</small></td>
                </tr>
            `).join('');
        };

        window.deleteStudent = async (id) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "students", id)); loadStudents(); }};
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; };

        // Initial Load
        loadStudents();
    </script>
</body>
</html>
