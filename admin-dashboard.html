<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Hub | Makki Masjid Gakuin</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; }
        .header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* Stats & Tabs */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid var(--gold); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #e0e0e0; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Tables */
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .bg-maktab { background: #e3f2fd; color: #1976d2; }
        .bg-hifz { background: #f3e5f5; color: #7b1fa2; }
        
        /* Modal System */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; width: 80%; max-width: 800px; border-radius: 12px; position: relative; padding-bottom: 20px; }
        .modal-header { background: var(--primary); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; }
        .modal-body { padding: 25px; }
        .modal-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .m-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; }
        .m-tab.active { border-color: var(--gold); color: var(--primary); }
        .hidden-pane { display: none; }
        .active-pane { display: block; }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #666; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; float: right; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Makki Masjid | Admin Hub</h2>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card"><h3 id="stat-all">0</h3><small>Students</small></div>
            <div class="stat-card"><h3 id="stat-maktab">0</h3><small>Maktab</small></div>
            <div class="stat-card"><h3 id="stat-nazera">0</h3><small>Nazera</small></div>
            <div class="stat-card"><h3 id="stat-hifz">0</h3><small>Hifz</small></div>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="showTab('list')">Student List</button>
            <button class="tab-btn" onclick="showTab('add')">Enroll New</button>
        </div>

        <div id="view-list" class="section">
            <input type="text" id="search" placeholder="ðŸ” Search by name or email..." onkeyup="filterList()" style="margin-bottom:20px;">
            <table>
                <thead>
                    <tr>
                        <th>Student Name (Age)</th>
                        <th>Parent Email</th>
                        <th>Division</th>
                        <th>Services</th>
                        <th>Monthly Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="student-list"></tbody>
            </table>
        </div>

        <div id="view-add" class="section" style="display:none;">
            <h3>New Enrollment</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-group"><label>Name</label><input type="text" id="new-name"></div>
                <div class="input-group"><label>Parent Email</label><input type="email" id="new-email"></div>
                <div class="input-group"><label>Date of Birth</label><input type="date" id="new-dob"></div>
                <div class="input-group">
                    <label>Division</label>
                    <select id="new-div">
                        <option value="Maktab">Maktab</option>
                        <option value="Nazera">Nazera</option>
                        <option value="Hifz">Hifz</option>
                    </select>
                </div>
            </div>
            <button class="btn-save" onclick="enrollStudent()">Enroll Student</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Student Profile</h3>
                <span onclick="closeModal()" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div class="modal-tabs">
                <div class="m-tab active" onclick="showPane('academic', this)">Academic</div>
                <div class="m-tab" onclick="showPane('financial', this)">Financial</div>
                <div class="m-tab" onclick="showPane('consultancy', this)">Consultancy</div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                
                <div id="pane-academic" class="active-pane">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-group">
                            <label>Division</label>
                            <select id="edit-div" onchange="modalLabelRefresh()">
                                <option value="Maktab">Maktab</option>
                                <option value="Nazera">Nazera</option>
                                <option value="Hifz">Hifz</option>
                            </select>
                        </div>
                        <div class="input-group"><label>Target ETA</label><input type="date" id="edit-eta"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:10px;">
                        <div class="input-group"><label id="lbl-g1">Goal 1</label><input type="number" id="edit-g1"></div>
                        <div class="input-group"><label id="lbl-g2">Goal 2</label><input type="number" id="edit-g2"></div>
                        <div class="input-group"><label id="lbl-g3">Goal 3</label><input type="number" id="edit-g3"></div>
                    </div>
                </div>

                <div id="pane-financial" class="hidden-pane">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="input-group"><label>Monthly Tuition (Â¥)</label><input type="number" id="edit-fee"></div>
                        <div class="input-group"><label>Transport Fee (Â¥)</label><input type="number" id="edit-trans"></div>
                        <div class="input-group"><label>Daylong Study Fee (Â¥)</label><input type="number" id="edit-daylong"></div>
                    </div>
                </div>

                <div id="pane-consultancy" class="hidden-pane">
                    <label>Teacher's Feedback / Consultancy Notes</label>
                    <textarea id="edit-feedback" rows="5" placeholder="Enter progress notes for parents..."></textarea>
                </div>

                <div style="margin-top:30px; border-top: 1px solid #eee; padding-top:20px;">
                    <button class="btn-save" onclick="saveStudent()">Update Hub</button>
                    <button onclick="deleteStudent()" style="background:red; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer;">Delete Record</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, addDoc, collection, getDocs, query, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Helpers
        window.showTab = (t) => {
            document.getElementById('view-list').style.display = t === 'list' ? 'block' : 'none';
            document.getElementById('view-add').style.display = t === 'add' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.showPane = (paneId, btn) => {
            document.querySelectorAll('.hidden-pane, .active-pane').forEach(p => p.className = 'hidden-pane');
            document.getElementById('pane-' + paneId).className = 'active-pane';
            document.querySelectorAll('.m-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        };

        function calcAge(dob) {
            if(!dob) return "N/A";
            return Math.floor((new Date() - new Date(dob)) / (1000 * 60 * 60 * 24 * 365.25));
        }

        // Logic
        window.loadStudents = async () => {
            const snap = await getDocs(collection(db, "students"));
            const list = document.getElementById('student-list');
            list.innerHTML = "";
            let counts = { Maktab:0, Nazera:0, Hifz:0, Total:0 };

            snap.forEach(d => {
                const s = { id: d.id, ...d.data() };
                counts.Total++;
                if(counts[s.division] !== undefined) counts[s.division]++;

                const totalMonth = (parseInt(s.monthlyFee)||0) + (parseInt(s.transportFee)||0) + (parseInt(s.daylongFee)||0);
                const services = [];
                if(s.transportFee > 0) services.push('ðŸšŒ');
                if(s.daylongFee > 0) services.push('ðŸ“–');

                list.innerHTML += `
                    <tr>
                        <td><strong>${s.name}</strong> (${calcAge(s.dob)}y)</td>
                        <td>${s.parentEmail}</td>
                        <td><span class="badge bg-${s.division.toLowerCase()}">${s.division}</span></td>
                        <td>${services.join(' ')}</td>
                        <td>Â¥${totalMonth}</td>
                        <td><button class="tab-btn" style="padding:5px 10px;" onclick="openHub('${s.id}')">Edit Profile</button></td>
                    </tr>
                `;
            });
            document.getElementById('stat-all').innerText = counts.Total;
            document.getElementById('stat-maktab').innerText = counts.Maktab;
            document.getElementById('stat-nazera').innerText = counts.Nazera;
            document.getElementById('stat-hifz').innerText = counts.Hifz;
        };

        window.openHub = async (id) => {
            const studentSnap = await getDocs(collection(db, "students"));
            const s = studentSnap.docs.find(d => d.id === id).data();
            
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-title').innerText = "Hub: " + s.name;
            document.getElementById('edit-div').value = s.division;
            document.getElementById('edit-eta').value = s.eta || "";
            document.getElementById('edit-g1').value = s.goals[0] || 0;
            document.getElementById('edit-g2').value = s.goals[1] || 0;
            document.getElementById('edit-g3').value = s.goals[2] || 0;
            document.getElementById('edit-fee').value = s.monthlyFee || 0;
            document.getElementById('edit-trans').value = s.transportFee || 0;
            document.getElementById('edit-daylong').value = s.daylongFee || 0;
            document.getElementById('edit-feedback').value = s.feedback || "";
            
            modalLabelRefresh();
            document.getElementById('editModal').style.display = 'block';
        };

        window.modalLabelRefresh = () => {
            const d = document.getElementById('edit-div').value;
            const l1 = document.getElementById('lbl-g1'), l2 = document.getElementById('lbl-g2'), l3 = document.getElementById('lbl-g3');
            if(d==='Hifz'){ l1.innerText="Para"; l2.innerText="Sabaqi"; l3.innerText="Manzil"; }
            else if(d==='Nazera'){ l1.innerText="Para No."; l2.innerText="Line"; l3.innerText="Tajweed"; }
            else { l1.innerText="Qaida Page"; l2.innerText="Dua No."; l3.innerText="Islamic St."; }
        };

        window.saveStudent = async () => {
            const id = document.getElementById('edit-id').value;
            await updateDoc(doc(db, "students", id), {
                division: document.getElementById('edit-div').value,
                eta: document.getElementById('edit-eta').value,
                goals: [document.getElementById('edit-g1').value, document.getElementById('edit-g2').value, document.getElementById('edit-g3').value],
                monthlyFee: parseInt(document.getElementById('edit-fee').value),
                transportFee: parseInt(document.getElementById('edit-trans').value),
                daylongFee: parseInt(document.getElementById('edit-daylong').value),
                feedback: document.getElementById('edit-feedback').value
            });
            closeModal(); loadStudents();
        };

        window.enrollStudent = async () => {
            await addDoc(collection(db, "students"), {
                name: document.getElementById('new-name').value,
                parentEmail: document.getElementById('new-email').value.toLowerCase(),
                dob: document.getElementById('new-dob').value,
                division: document.getElementById('new-div').value,
                monthlyFee: 0, transportFee: 0, daylongFee: 0, goals: [0,0,0], feedback: ""
            });
            showTab('list'); loadStudents();
        };

        window.closeModal = () => document.getElementById('editModal').style.display = 'none';
        window.deleteStudent = async () => { if(confirm("Delete?")){ await deleteDoc(doc(db, "students", document.getElementById('edit-id').value)); closeModal(); loadStudents(); } };
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; };

        loadStudents();
    </script>
</body>
</html>
