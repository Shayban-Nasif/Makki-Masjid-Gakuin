<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal | Makki Masjid Gakuin</title>
    <style>
        :root { --primary: #004d40; --gold: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
        .parent-container { max-width: 900px; margin: 20px auto; padding: 20px; }
        
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header h2 { margin: 0; font-size: 1.5rem; }
        
        .nav-tabs { display: flex; gap: 10px; margin: 25px 0; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; transition: 0.3s; border-radius: 6px; }
        .tab.active { background: var(--primary); color: white; }

        .child-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 25px; border-top: 5px solid var(--gold); }
        .child-card h3 { color: var(--primary); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .log-title { font-size: 0.9rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; border-bottom: 1px solid #ddd; }
        
        .progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; }
        .bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .bar-fill { background: var(--gold); height: 100%; transition: 0.5s; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 80%; max-width: 600px; max-height: 70vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #666; }
        .history-item { border-bottom: 1px solid #eee; padding: 15px 0; white-space: pre-wrap; }

        .monthly-table-wrapper { overflow-x: auto; margin-top: 15px; }
        .monthly-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .monthly-table th, .monthly-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .monthly-table th { background-color: var(--primary); color: white; }
        .cell-p { background-color: #e8f5e9; color: #2e7d32; font-weight: bold; }
        .cell-a { background-color: #ffebee; color: #c62828; font-weight: bold; }

        .invoice-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .paid-badge { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="parent-container">
        <div class="header">
            <div>
                <h2 id="parentGreeting">Parent Portal</h2>
                <span id="currentDateDisplay" style="opacity: 0.8;"></span>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div id="parentNoticeDisplay" style="margin-top: 20px;"></div>

        <div id="historyModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeHistory()">&times;</span>
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--gold); padding-bottom: 10px;">Notice History</h3>
                <div id="historyList"></div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab active" id="btnReport" onclick="switchTab('report')">Academic Progress</button>
            <button class="tab" id="btnFinance" onclick="switchTab('finance')">Fees & Invoices</button>
        </div>

        <div id="childrenContainer">
            <div style="text-align:center; padding: 50px; color: #666;">Loading student data...</div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
    authDomain: "makki-masjid-gakuin.firebaseapp.com",
    projectId: "makki-masjid-gakuin",
    storageBucket: "makki-masjid-gakuin.firebasestorage.app",
    messagingSenderId: "376596641128",
    appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const parentEmail = localStorage.getItem('userEmail');
let studentsData = [];

async function init() {
    if (!parentEmail) { window.location.href = 'index.html'; return; }
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('ja-JP');
    try {
        const q = query(collection(db, "students"), where("parentEmail", "==", parentEmail));
        const studentSnap = await getDocs(q);
        studentsData = studentSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderView('report');
        displayNotices();
    } catch (e) {
        console.error(e);
        document.getElementById('childrenContainer').innerHTML = "Error loading data.";
    }
}

window.renderView = async (view) => {
    const container = document.getElementById('childrenContainer');
    container.innerHTML = "";
    
    if (studentsData.length === 0) {
        container.innerHTML = `<div class='child-card'>No students linked to ${parentEmail}</div>`;
        return;
    }

    for (const child of studentsData) {
        const card = document.createElement('div');
        card.className = 'child-card';

        if (view === 'report') {
            const lv = child.levels || { c1: 0, c2: 0, c3: 0 };
            const gl = child.goals || { c1: 1, c2: 1, c3: 1 };
            const labels = getDivisionLabels(child.division);
            
            // FILTER ONLY ACADEMIC LOGS
            const academicLogs = (child.logs || []).filter(l => l.type === "academic");

            let tableRows = academicLogs.length > 0 ? academicLogs.map(log => {
                const attn = log.text.match(/\[Attn: (.*?)\]/)?.[1] || '-';
                const perf = log.text.match(/\[Perf: (.*?)\]/)?.[1] || '-';
                const parts = log.text.split('|');
                const s1 = parts[0] ? parts[0].split(':').pop().trim() : '-';
                const s2 = parts[1] ? parts[1].split(':').pop().trim() : '-';
                const s3 = parts[2] ? parts[2].split(':').pop().trim() : '-';

                return `<tr>
                    <td>${log.date}</td>
                    <td class="${attn === 'P' ? 'cell-p' : 'cell-a'}">${attn}</td>
                    <td>${s1}</td><td>${s2}</td><td>${s3}</td>
                    <td>${perf}</td>
                </tr>`;
            }).join('') : `<tr><td colspan="6">No academic records found.</td></tr>`;

            card.innerHTML = `
                <h3>${child.name} <small style="float:right; color:#666; font-size:0.8rem;">${child.division}</small></h3>
                ${bar(labels[0], lv.c1, gl.c1)}
                ${bar(labels[1], lv.c2, gl.c2)}
                ${bar(labels[2], lv.c3, gl.c3)}
                <div class="monthly-table-wrapper">
                    <span class="log-title">ðŸ“… Academic Record Table</span>
                    <table class="monthly-table">
                        <thead><tr><th>Date</th><th>Attn</th><th>${labels[0]}</th><th>${labels[1]}</th><th>${labels[2]}</th><th>Perf.</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>`;
        } else {
            // FINANCE VIEW - Fetching from 'payments' collection
            const payQuery = query(collection(db, "payments"), where("studentId", "==", child.id), orderBy("timestamp", "desc"));
            const paySnap = await getDocs(payQuery);
            
            let payHtml = `<span class="log-title">ðŸ’³ Payment History</span>`;
            if (paySnap.empty) {
                payHtml += `<p style="color:#666;">No payment records found.</p>`;
            } else {
                paySnap.forEach(pDoc => {
                    const p = pDoc.data();
                    payHtml += `
                        <div class="invoice-card">
                            <div>
                                <strong>${p.monthName} ${p.year}</strong><br>
                                <small>Paid on: ${p.datePaid || p.date || '-'}</small>
                            </div>
                            <div>
                                <span style="font-weight:bold; margin-right:10px;">Â¥${p.amount}</span>
                                <span class="paid-badge">PAID</span>
                            </div>
                        </div>`;
                });
            }
            card.innerHTML = `<h3>${child.name} - Invoices</h3>${payHtml}`;
        }
        container.appendChild(card);
    }
};

function bar(label, cur, goal) {
    const perc = goal > 0 ? Math.min((cur / goal) * 100, 100) : 0;
    return `
        <div class="progress-label"><span>${label}</span><span>${cur || 0} / ${goal || 0}</span></div>
        <div class="bar-bg"><div class="bar-fill" style="width:${perc}%"></div></div>
    `;
}

function getDivisionLabels(div) {
    const labels = {
        "Maktab": ["Qaida/Quran", "Dua", "Islamic Studies"],
        "Nazera": ["Quran Reading", "Tajweed Rule", "Memorization"],
        "Hifz": ["New Sabaq", "Sabaqi", "Manzil"]
    };
    return labels[div] || ["S1", "S2", "S3"];
}

window.switchTab = (view) => {
    document.getElementById('btnReport').classList.toggle('active', view === 'report');
    document.getElementById('btnFinance').classList.toggle('active', view === 'finance');
    renderView(view);
};

window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };

window.displayNotices = async () => {
    try {
        const q = query(collection(db, "notices"), orderBy("timestamp", "desc"), limit(5));
        const snap = await getDocs(q);
        const noticeDiv = document.getElementById('parentNoticeDisplay');
        const historyList = document.getElementById('historyList');
        noticeDiv.innerHTML = ""; historyList.innerHTML = "";
        
        let i = 0;
        snap.forEach(docSnap => {
            const data = docSnap.data();
            if (i === 0) {
                noticeDiv.innerHTML = `<div style="background:#fff9c4; border-left:5px solid #fbc02d; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="white-space: pre-wrap;"><strong>Latest Notice:</strong>\n${data.message}</span>
                    <button onclick="window.openHistory()" style="padding:5px 10px; cursor:pointer;">History</button>
                </div>`;
            }
            historyList.innerHTML += `<div class="history-item"><b>${data.date}</b><br>${data.message}</div>`;
            i++;
        });
    } catch (e) { console.log(e); }
};

window.openHistory = () => { document.getElementById('historyModal').style.display = 'block'; };
window.closeHistory = () => { document.getElementById('historyModal').style.display = 'none'; };

init();
</script>
</body>
</html>
