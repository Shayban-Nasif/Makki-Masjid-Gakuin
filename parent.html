<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal | Makki Masjid Gakuin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .parent-container { max-width: 800px; margin: 20px auto; padding: 20px; font-family: sans-serif; }
        .child-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; border-left: 5px solid #004d40; }
        .fee-badge { display: inline-block; padding: 10px 20px; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .paid { background: #e8f5e9; color: #2e7d32; }
        .unpaid { background: #ffebee; color: #c62828; }
        
        .finance-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .finance-table td { padding: 8px 0; border-bottom: 1px dashed #ddd; font-size: 0.95rem; }
        .finance-table .label { color: #666; }
        .finance-table .amount { text-align: right; font-weight: bold; }
        .total-row { font-size: 1.1rem; color: #004d40; border-top: 2px solid #004d40 !important; }
        
        .extra-reason { font-size: 0.8rem; color: #777; font-weight: normal; display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body style="background: #f4f7f6;">

    <div class="parent-container">
        <div class="header">
            <h2>Welcome, Parent</h2>
            <button onclick="logout()" style="background:#666; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>

        <div id="childrenContainer">
            <p>Loading children details...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const parentEmail = localStorage.getItem('userEmail');
        const currentMonthYear = "January 2026";

        async function loadParentDashboard() {
            if (!parentEmail) { window.location.href = 'index.html'; return; }

            const q = query(collection(db, "students"), where("parentEmail", "==", parentEmail));
            const querySnapshot = await getDocs(q);
            const container = document.getElementById('childrenContainer');
            container.innerHTML = "";

            if (querySnapshot.empty) {
                container.innerHTML = "<p>No enrolled students found for this email.</p>";
                return;
            }

            // Get payments for this month
            const paySnap = await getDocs(query(collection(db, "payments"), where("month", "==", currentMonthYear)));
            const paidIds = paySnap.docs.map(d => d.data().studentId);

            querySnapshot.forEach((docSnap) => {
                const child = docSnap.data();
                const cid = docSnap.id;
                const isPaid = paidIds.includes(cid);

                const mFee = child.monthlyFee || 0;
                const tFee = child.transportFee || 0;
                const eFee = child.extraCharge || 0;
                const total = isPaid ? 0 : (mFee + tFee + eFee);

                const card = document.createElement('div');
                card.className = 'child-card';
                card.innerHTML = `
                    <h3>${child.name} <small style="color:#666; font-weight:normal;">(${child.division})</small></h3>
                    
                    <table class="finance-table">
                        <tr>
                            <td class="label">Monthly Tuition</td>
                            <td class="amount">¥${mFee}</td>
                        </tr>
                        <tr>
                            <td class="label">Transportation</td>
                            <td class="amount">¥${tFee}</td>
                        </tr>
                        ${eFee > 0 ? `
                        <tr>
                            <td class="label">Extra Charges / Donation
                                <span class="extra-reason">${child.extraChargeReason || 'Special Charge'}</span>
                            </td>
                            <td class="amount">¥${eFee}</td>
                        </tr>` : ''}
                        <tr class="total-row">
                            <td class="label"><strong>Total Owed for ${currentMonthYear}</strong></td>
                            <td class="amount">¥${total}</td>
                        </tr>
                    </table>

                    <div class="fee-badge ${isPaid ? 'paid' : 'unpaid'}">
                        ${isPaid ? 'Status: PAID ✅' : 'Status: UNPAID (Please visit office)'}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };
        loadParentDashboard();
    </script>
</body>
</html>
