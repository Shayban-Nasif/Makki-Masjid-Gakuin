<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal | Makki Masjid Gakuin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .parent-container { max-width: 800px; margin: 20px auto; padding: 20px; font-family: sans-serif; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Navigation Tabs */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; }
        .tab.active { color: #004d40; border-bottom: 3px solid #004d40; }

        .child-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; border-left: 5px solid #004d40; }
        
        /* Progress Styles */
        .progress-row { margin: 15px 0; }
        .progress-bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { background: #d4af37; height: 100%; transition: width 0.5s; }
        
        /* Finance Styles */
        .finance-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .finance-table td { padding: 8px 0; border-bottom: 1px dashed #ddd; font-size: 0.95rem; }
        .total-row { font-size: 1.1rem; color: #004d40; border-top: 2px solid #004d40 !important; font-weight: bold; }
        .fee-badge { display: inline-block; padding: 8px 15px; border-radius: 6px; font-weight: bold; margin-top: 15px; font-size: 0.85rem; }
        .paid { background: #e8f5e9; color: #2e7d32; }
        .unpaid { background: #ffebee; color: #c62828; }

        .hidden { display: none; }
    </style>
</head>
<body style="background: #f4f7f6;">

    <div class="parent-container">
        <div class="header">
            <div>
                <h2 id="parentGreeting">Welcome, Parent</h2>
                <p id="currentMonthLabel" style="color: #666; margin: 0;"></p>
            </div>
            <button onclick="logout()" style="background:#666; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="tab active" id="btnReport" onclick="switchTab('report')">Progress Report</button>
            <button class="tab" id="btnFinance" onclick="switchTab('finance')">Finance & Fees</button>
        </div>

        <div id="childrenContainer">
            <p>Loading details...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const parentEmail = localStorage.getItem('userEmail');
        const currentMonthYear = "January 2026";
        document.getElementById('currentMonthLabel').innerText = currentMonthYear;

        let studentsData = [];
        let paidIds = [];

        async function loadData() {
            if (!parentEmail) { window.location.href = 'index.html'; return; }

            const q = query(collection(db, "students"), where("parentEmail", "==", parentEmail));
            const querySnapshot = await getDocs(q);
            
            const paySnap = await getDocs(query(collection(db, "payments"), where("month", "==", currentMonthYear)));
            paidIds = paySnap.docs.map(d => d.data().studentId);

            studentsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderDashboard('report'); 
        }

        window.renderDashboard = (view) => {
            const container = document.getElementById('childrenContainer');
            container.innerHTML = "";

            studentsData.forEach(child => {
                const card = document.createElement('div');
                card.className = 'child-card';

                if (view === 'report') {
                    // PROGRESS REPORT VIEW
                    const labels = getLabels(child.division);
                    card.innerHTML = `
                        <h3>${child.name} <small>(${child.division})</small></h3>
                        <div class="progress-row">${renderProgress(labels[0], child.levels?.c1, child.goals?.c1)}</div>
                        <div class="progress-row">${renderProgress(labels[1], child.levels?.c2, child.goals?.c2)}</div>
                        <div class="progress-row">${renderProgress(labels[2], child.levels?.c3, child.goals?.c3)}</div>
                        <p style="margin-top:15px; font-size:0.9rem;"><strong>Target Completion:</strong> ${child.eta || 'TBD'}</p>
                    `;
                } else {
                    // FINANCE VIEW
                    const isPaid = paidIds.includes(child.id);
                    const total = isPaid ? 0 : ((child.monthlyFee || 0) + (child.transportFee || 0) + (child.extraCharge || 0));
                    
                    card.innerHTML = `
                        <h3>${child.name} - Fee Breakdown</h3>
                        <table class="finance-table">
                            <tr><td>Tuition Fee</td><td style="text-align:right">¥${child.monthlyFee || 0}</td></tr>
                            <tr><td>Transport</td><td style="text-align:right">¥${child.transportFee || 0}</td></tr>
                            ${child.extraCharge > 0 ? `<tr><td>${child.extraChargeReason || 'Extra'}<br><small>One-time</small></td><td style="text-align:right">¥${child.extraCharge}</td></tr>` : ''}
                            <tr class="total-row"><td>Total Due</td><td style="text-align:right">¥${total}</td></tr>
                        </table>
                        <div class="fee-badge ${isPaid ? 'paid' : 'unpaid'}">
                            ${isPaid ? 'Status: PAID ✅' : 'Status: UNPAID'}
                        </div>
                    `;
                }
                container.appendChild(card);
            });
        };

        function renderProgress(label, current, goal) {
            const perc = goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
            return `
                <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
                    <span>${label}</span><span>${current || 0} / ${goal || 0}</span>
                </div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${perc}%"></div></div>
            `;
        }

        function getLabels(div) {
            if (div === "Nazera") return ["Nazera", "Tajweed", "Dua/IS"];
            if (div === "Hifz") return ["Sabaq", "Sabaq Para", "Ammi"];
            return ["Qaida", "Dua", "Islamic Studies"]; // Default Maktab
        }

        window.switchTab = (view) => {
            document.getElementById('btnReport').classList.toggle('active', view === 'report');
            document.getElementById('btnFinance').classList.toggle('active', view === 'finance');
            renderDashboard(view);
        };

        window.logout = () => { localStorage.clear(); window.location.href = 'index.html'; };
        loadData();
    </script>
</body>
</html>
