<script type="module">
    // ... Firebase Init same as above ...
    
    window.saveAllBatch = async () => {
        const rows = document.querySelectorAll('#batchTableBody tr');
        const labels = divisionLabels[teacherData.division];
        const date = document.getElementById('batchDate').value || new Date().toLocaleDateString();

        for (let row of rows) {
            const sid = row.dataset.sid;
            const lv = {
                c1: parseInt(row.querySelector('.l1').value) || 0,
                c2: parseInt(row.querySelector('.l2').value) || 0,
                c3: parseInt(row.querySelector('.l3').value) || 0
            };
            const p1 = row.querySelector('.p1').value || "-";
            const p2 = row.querySelector('.p2').value || "-";
            const p3 = row.querySelector('.p3').value || "-";
            const perf = row.querySelector('.perf').value;
            const attn = row.querySelector('.attn').value;

            // Strict format for parsing in Parent/Admin
            const logText = `[Attn: ${attn}] [Perf: ${perf}] ${labels[0]}: Lv ${lv.c1} Pg ${p1} | ${labels[1]}: Lv ${lv.c2} Pg ${p2} | ${labels[2]}: Lv ${lv.c3} Pg ${p3}`;
            
            const sRef = doc(db, "students", sid);
            const sSnap = await getDoc(sRef);
            const currentLogs = sSnap.data().logs || [];

            await updateDoc(sRef, {
                levels: lv,
                logs: [{ date, text: logText, type: "academic", timestamp: new Date() }, ...currentLogs].slice(0, 60)
            });
        }
        alert("Success!");
    };
</script>
