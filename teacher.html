<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Panel | Makki Masjid Gakuin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .teacher-container { padding: 20px; max-width: 1000px; margin: auto; }
        .nav-header { display: flex; justify-content: space-between; align-items: center; background: #004d40; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; }
        .division-badge { background: var(--gold); color: #000; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
        
        .student-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 5px solid #004d40; }
        .student-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .lesson-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .lesson-field label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        
        .attendance-toggle { display: flex; gap: 5px; }
        .status-btn { border: 1px solid #ddd; padding: 8px 12px; cursor: pointer; border-radius: 4px; background: #fff; font-weight: bold; }
        
        .save-bar { position: sticky; bottom: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="teacher-container">
        <header class="nav-header">
            <div>
                <h2 id="teacherWelcome">Teacher Dashboard</h2>
                <span class="division-badge" id="displayDivision">Loading Division...</span>
            </div>
            <button onclick="window.location.href='index.html'" class="status-btn">Logout</button>
        </header>

        <section id="studentList">
            <p>Loading your students...</p>
        </section>

        <div class="save-bar">
            <span>Date: <strong id="currentDate"></strong></span>
            <button id="saveAllBtn" class="login-btn" style="width: 200px;">Save All Progress</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdA02h0pqEEQunobeSM4emZfPW1EjMKu4",
            authDomain: "makki-masjid-gakuin.firebaseapp.com",
            projectId: "makki-masjid-gakuin",
            storageBucket: "makki-masjid-gakuin.firebasestorage.app",
            messagingSenderId: "376596641128",
            appId: "1:376596641128:web:b49c1233aaed64ae6552dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // CONFIGURATION PER DIVISION
        const divisionBlueprints = {
            "Maktab": ["Qaida/Quran", "Dua", "Islamic Studies"],
            "Nazera": ["Nazera Juz", "Dua", "Islamic Studies"],
            "Hifz": ["Sabaq", "Sabaq Para", "Ammi"]
        };

        // 1. Identify Teacher (In a real app, this comes from the Login session)
        // For now, let's assume we are viewing the "Hifz" division. 
        // Later, we can make this dynamic based on who logged in.
        let teacherDivision = "Hifz"; 

        async function initDashboard() {
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString();
            document.getElementById('displayDivision').innerText = teacherDivision + " Division";
            await loadStudents();
        }

        async function loadStudents() {
            const listContainer = document.getElementById('studentList');
            const labels = divisionBlueprints[teacherDivision];

            try {
                // Fetch only students in THIS division
                const q = query(collection(db, "students"), where("division", "==", teacherDivision));
                const querySnapshot = await getDocs(q);
                
                listContainer.innerHTML = "";

                if (querySnapshot.empty) {
                    listContainer.innerHTML = `<p>No students found for ${teacherDivision}.</p>`;
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const student = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.setAttribute('data-id', docSnap.id);
                    card.setAttribute('data-name', student.name);

                    card.innerHTML = `
                        <div class="student-header">
                            <strong>${student.name}</strong>
                            <div class="attendance-toggle">
                                <button class="status-btn p-btn" onclick="markAttendance(this, 'present')">P</button>
                                <button class="status-btn a-btn" onclick="markAttendance(this, 'absent')">A</button>
                            </div>
                        </div>
                        <div class="lesson-grid">
                            <div class="lesson-field">
                                <label>${labels[0]}</label>
                                <input type="text" class="input-1" placeholder="Enter progress">
                            </div>
                            <div class="lesson-field">
                                <label>${labels[1]}</label>
                                <input type="text" class="input-2" placeholder="Enter progress">
                            </div>
                            <div class="lesson-field">
                                <label>${labels[2]}</label>
                                <input type="text" class="input-3" placeholder="Enter progress">
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            } catch (err) {
                listContainer.innerHTML = "Error: " + err.message;
            }
        }

        // Attendance Toggle Logic
        window.markAttendance = (btn, status) => {
            const parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(b => b.classList.remove('present', 'absent'));
            btn.classList.add(status === 'present' ? 'present' : 'absent');
        };

        // SAVE ALL DATA
        document.getElementById('saveAllBtn').onclick = async () => {
            const cards = document.querySelectorAll('.student-card');
            const today = new Date().toISOString().split('T')[0];
            const saveBtn = document.getElementById('saveAllBtn');
            
            saveBtn.innerText = "Processing...";
            saveBtn.disabled = true;

            try {
                for (let card of cards) {
                    const name = card.getAttribute('data-name');
                    const isP = card.querySelector('.p-btn').classList.contains('present');
                    const isA = card.querySelector('.a-btn').classList.contains('absent');
                    const status = isP ? "Present" : (isA ? "Absent" : "Not Marked");

                    const lesson1 = card.querySelector('.input-1').value;
                    const lesson2 = card.querySelector('.input-2').value;
                    const lesson3 = card.querySelector('.input-3').value;

                    // Save to Daily Logs
                    await addDoc(collection(db, "daily_logs"), {
                        studentName: name,
                        division: teacherDivision,
                        date: today,
                        attendance: status,
                        lessons: [lesson1, lesson2, lesson3],
                        timestamp: new Date()
                    });
                }
                alert("All records saved successfully!");
            } catch (err) {
                alert("Save failed: " + err.message);
            } finally {
                saveBtn.innerText = "Save All Progress";
                saveBtn.disabled = false;
            }
        };

        initDashboard();
    </script>
</body>
</html>
